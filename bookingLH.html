<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LHMS Booking Form</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { font-size: 16px; background-color: #e0e7ff; padding: 20px; color: #333; }
    .container { max-width: 800px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
    .header h1 { font-size: 2rem; font-weight: bold;}
    .subtitle { color: #666; margin-bottom: 30px; font-size: 1rem;}
    .form-row { display: flex; gap: 20px; margin-bottom: 20px;}
    .form-group { flex: 1;}
    .form-group.full-width { flex: none; width: 100%;}
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem;}
    .required { color: #e74c3c;}
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;}
    input:focus, select:focus, textarea:focus { border-color: #3498db; outline: none; }
    select { background-color: white; }
    .time-row { display: flex; gap: 20px; align-items: end;}
    .time-group { flex: 1;}
    textarea { height: 80px; resize: vertical; }
    .terms-section { margin: 25px 0; display: flex; align-items: center; gap: 10px;}
    .terms-section input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer;}
    .terms-section label { font-weight: normal; font-size: 0.9rem;}
    .terms-link { color: #3498db; text-decoration: underline;}
    .submit-btn { background-color: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;}
    .submit-btn:hover { background-color: #2980b9;}
    .info-section { background-color: #f8f9fa; padding: 20px; border-radius: 4px; margin-top: 30px; border-left: 4px solid #3498db;}
    .info-section h3 { font-size: 1.1rem; margin-bottom: 15px;}
    .info-section ul { list-style: none; padding: 0;}
    .info-section li { font-size: 0.95rem; margin-bottom: 8px; padding-left: 15px; position: relative;}
    .info-section li:before { content: "•"; color: #3498db; position: absolute; left: 0;}
    .slot-list {margin-bottom: 15px; font-size: 1rem; font-weight: 500; color: #1976d2;}
    .readonly-message, .readonly-date-message { color: #e67e22; font-size: 0.97rem; margin-bottom: 14px; font-weight: 500; }
    @media (max-width: 600px) {
      .form-row, .time-row, .terms-section { flex-direction: column; align-items: flex-start;}
    }
  </style>  
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="dynamic-form-title">LHMS Booking Form</h1>
    </div>
    <p class="subtitle">Fill out the form below to request a lecture hall booking.</p>
    <div class="readonly-date-message" id="readonly-date-message" style="display:none;">
      Booking date is set based on your selection in the timetable. To change, please re-select on the timetable page.
    </div>
    <div class="readonly-message" id="readonly-message" style="display:none;">
      Times are set based on your slot selection in the timetable. To change, please re-select slots on the timetable page.
    </div>
    <div class="slot-list" id="slot-list" style="display:none;"></div>
    <form id="bookingForm">
      <div class="form-row">
        <div class="form-group">
          <label for="fullname">Full Name</label>
          <input type="text" id="fullname" name="fullname" required />
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" name="phone" />
        </div>
        <div class="form-group">
          <label for="faculty-dept">Faculty/Department</label>
          <select id="faculty-dept" name="facultydept">
            <option value="">--Select Faculty--</option>
            <option value="engineering">Engineering</option>
            <option value="medicine">Medicine</option>
            <option value="business">Business</option>
            <option value="arts">Arts & Sciences</option>
            <option value="education">Education</option>
          </select>
        </div>
      </div>
      <div class="form-group full-width">
        <label for="select-facility">Select Facility <span class="required">*</span></label>
        <select id="select-facility" name="select-facility" required>
          <option value="">--Select Facility--</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="booking-date">Booking Date <span class="required">*</span></label>
          <input type="date" id="booking-date" name="booking-date" required />
        </div>
        <div class="time-row">
          <div class="time-group">
            <label for="start-time">Start Time <span class="required">*</span></label>
            <input type="time" id="start-time" name="start-time" required />
          </div>
          <div class="time-group">
            <label for="end-time">End Time <span class="required">*</span></label>
            <input type="time" id="end-time" name="end-time" required />
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="participants">Expected Number of Participants <span class="required">*</span></label>
        <input type="number" id="participants" name="participants" min="1" required />
      </div>
      <div class="form-group">
        <label for="purpose">Purpose/Event Type</label>
        <select id="purpose" name="purpose">
          <option value="">--Select Purpose--</option>
          <option value="lecture">Lecture</option>
          <option value="seminar">Seminar</option>
          <option value="workshop">Workshop</option>
          <option value="conference">Conference</option>
          <option value="meeting">Meeting</option>
          <option value="exam">Examination</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label for="description">Event Description/Additional Notes</label>
        <textarea id="description" name="description" placeholder="please provide details about your event..."></textarea>
      </div>
      <div class="terms-section">
        <input type="checkbox" id="terms" name="terms" required />
        <label for="terms">I agree to the <a href="#" class="terms-link">terms and conditions</a> of LHMS</label>
      </div>
      <button type="submit" class="submit-btn">Submit Booking Request</button>
    </form>
    <div class="info-section">
      <h3>Booking Information</h3>
      <ul>
        <li>Bookings must be made at least 24 hours in advance</li>
        <li>Maximum booking duration: 4 hours per session</li>
        <li>Available Monday-Friday: 8:00 AM - 6:00 PM</li>
        <li>Saturday: 8:00 AM - 12:00 PM only</li>
        <li>You will receive a confirmation email within 24 hours</li>
      </ul>
    </div>
  </div>
  <script>
  const API = 'http://localhost:3000';

  // 1. Use ONLY new slot format in all JS
  const slotTo24h = {
    "8.00": "08:00",
    "9.00": "09:00",
    "10.00": "10:00",
    "11.00": "11:00",
    "12.00": "12:00",
    "13.00": "13:00",
    "14.00": "14:00",
    "15.00": "15:00",
    "16.00": "16:00",
    "17.00": "17:00"
  };

  function normalizeSlot(str) {
    // Converts any slot string to "h.mm-hh.mm"
    let [start, end] = str.replace(/\s/g, "").replace(/:/g, ".").split("-");
    return start + "-" + end;
  }

  // Convert slot string to 24h time for form input
  function timeRangeTo24h(str, isStart) {
    if (!str) return "";
    let [start, end] = normalizeSlot(str).split("-");
    if (isStart) return slotTo24h[start] || "00:00";
    else return slotTo24h[end] || "00:00";
  }

  // Full list of timetable slots for lookups (for validation)
  const timetableSlots = [
    "8.00-9.00", "9.00-10.00", "10.00-11.00", "11.00-12.00",
    "12.00-13.00", "13.00-14.00", "14.00-15.00", "15.00-16.00", "16.00-17.00"
  ];

  // Parse URL parameters into an object
  function getQueryParams() {
    const params = {};
    window.location.search.substr(1).split("&").forEach(function (item) {
      if (!item) return;
      let [k, v] = item.split("=");
      k = decodeURIComponent(k.replace(/\[\]$/,""));
      v = decodeURIComponent(v || "");
      if (params[k]) {
        if (!Array.isArray(params[k])) params[k] = [params[k]];
        params[k].push(v);
      } else {
        params[k] = v;
      }
    });
    return params;
  }

  // Extract time slots from URL params (supports both times[] and times)
  function extractSlotsFromParams(params) {
    let slots = [];
    if (params['times[]']) {
      if (Array.isArray(params['times[]'])) slots = slots.concat(params['times[]']);
      else slots.push(params['times[]']);
    }
    if (params.times) {
      if (Array.isArray(params.times)) slots = slots.concat(params.times);
      else slots.push(params.times);
    }
    slots = slots.filter(Boolean).map(normalizeSlot);
    return slots;
  }

  // Get slots array for a range of start/end time (for validation fallback)
  function getSlotArray(startTime, endTime) {
    // Find the indices
    let startIdx = timetableSlots.findIndex(slot => slotTo24h[slot.split("-")[0]] === startTime);
    let endIdx = timetableSlots.findIndex(slot => slotTo24h[slot.split("-")[1]] === endTime);
    if (startIdx === -1 || endIdx === -1 || endIdx < startIdx) return [];
    return timetableSlots.slice(startIdx, endIdx+1);
  }

  // ISO date for input
  function toISODate(dstr) {
    if (/^\d{4}-\d{2}-\d{2}$/.test(dstr)) return dstr;
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(dstr)) {
      let [mm,dd,yyyy] = dstr.split("/");
      return `${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`;
    }
    let [day,mon,yr] = dstr.split(" ");
    if (!day || !mon || !yr) return "";
    let mm = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(mon)+1;
    return `${yr}-${mm<10?"0"+mm:mm}-${day.padStart(2,"0")}`;
  }

  const params = getQueryParams();

  function setFacilityHeading() {
    let facility = params.facility;
    if (facility) {
      try { facility = decodeURIComponent(facility); } catch(e) {}
      facility = facility.replace(/[_+]/g, " ");
      document.getElementById("dynamic-form-title").textContent =
        "LHMS Booking Form - " + facility.trim();
    }
  }
  setFacilityHeading();

  async function populateFacilityDropdown(selectedFacilityFromURL) {
    try {
      const res = await fetch(API + '/api/facilities');
      const facilities = await res.json();
      const select = document.getElementById('select-facility');
      select.innerHTML = '<option value="">--Select Facility--</option>';
      facilities.forEach(fac => {
        if(!fac.facilityName) return;
        const opt = document.createElement('option');
        opt.value = fac.facilityName;
        opt.textContent = fac.facilityName;
        select.appendChild(opt);
      });
      if (selectedFacilityFromURL) {
        for(let i=0; i<select.options.length; i++) {
          if(select.options[i].text.trim().toLowerCase() === selectedFacilityFromURL.trim().toLowerCase()) {
            select.selectedIndex = i;
            break;
          }
        }
      }
    } catch (err) {
      alert("Failed to load facility list!");
      console.error(err);
    }
  }

  window.addEventListener('DOMContentLoaded', async function() {
    let facilityFromURL = "";
    if(params.facility) {
      facilityFromURL = params.facility.replace(/_/g, " ").replace(/\+/g, " ").trim();
    }
    await populateFacilityDropdown(facilityFromURL);

    // Set booking date if provided and lock it
    if(params.date) {
      let dateStr = params.date;
      if(Array.isArray(dateStr)) dateStr = dateStr[0];
      dateStr = decodeURIComponent(dateStr);
      let isoDate = toISODate(dateStr);
      if (isoDate) {
        document.getElementById('booking-date').value = isoDate;
        document.getElementById('booking-date').readOnly = true;
        document.getElementById('readonly-date-message').style.display = 'block';
      }
    }

    // Set time slots if present in URL, and lock time inputs
    const slots = extractSlotsFromParams(params);
    if(slots.length > 0) {
      document.getElementById('slot-list').style.display = 'block';
      document.getElementById('slot-list').textContent = "Selected Time Slots: " + slots.join(", ");
      let [start, end] = [slots[0], slots[slots.length - 1]];
      document.getElementById('start-time').value = timeRangeTo24h(start, true);
      document.getElementById('end-time').value = timeRangeTo24h(end, false);
      document.getElementById('start-time').readOnly = true;
      document.getElementById('end-time').readOnly = true;
      document.getElementById('readonly-message').style.display = 'block';
    }
  });

  async function submitTimetable(e) {
    e.preventDefault();
const data = {
  fullname: document.getElementById('fullname').value.trim(),
  email: document.getElementById('email').value.trim(),
  phone: document.getElementById('phone').value.trim(),
  facultyDept: document.getElementById('faculty-dept').value,
  facility: document.getElementById('select-facility').value,
  bookingDate: document.getElementById('booking-date').value,
  startTime: document.getElementById('start-time').value,
  endTime: document.getElementById('end-time').value,
  participants: parseInt(document.getElementById('participants').value),
  purpose: document.getElementById('purpose').value,
  description: document.getElementById('description').value.trim(),
  terms: document.getElementById('terms').checked,

  // ✅ Hidden identity link
  ownerId:    localStorage.getItem('lhms_userId'),
  ownerEmail: localStorage.getItem('lhms_email'),
  ownerName:  localStorage.getItem('lhms_fullname')
};


    if (!data.fullname || !data.email || !data.bookingDate || !data.startTime || !data.endTime || !data.participants || !data.facility) {
      alert("Please fill in all required fields.");
      return;
    }
    if (!data.terms) {
      alert("Please agree to the terms and conditions.");
      return;
    }

    // Use slots from URL params if present
    let slots = extractSlotsFromParams(params);
    if (!slots.length) {
      slots = getSlotArray(data.startTime, data.endTime);
    }

    // Always use normalized slots for booking!
    const normalizedSlots = slots.map(normalizeSlot);

    // Check if slots and times match (optional, for extra safety)
    const computedSlots = getSlotArray(data.startTime, data.endTime).map(normalizeSlot);
    if (normalizedSlots.length !== computedSlots.length || !normalizedSlots.every((val, idx) => val === computedSlots[idx])) {
      alert("Selected time slots and Start/End time do not match! Please ensure they match your original selection.");
      return;
    }

    try {
      const response = await fetch(API + '/api/booking', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        const errorData = await response.json();
        alert(errorData.message || "Error submitting booking!");
        console.error("Booking API error:", errorData);
        return;
      }
      const result = await response.json();

      const timetableCollection = data.facility.replace(/\s+/g, '').toLowerCase() + "_timetable";
      const timetableRes = await fetch(`${API}/api/timetable/${timetableCollection}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          date: data.bookingDate,
          times: normalizedSlots,
          bookedBy: data.email,
          bookingId: result._id || ""
        })
      });

      if (!timetableRes.ok) {
        const err = await timetableRes.json();
        alert("Failed to add booking to timetable: " + err.message);
        console.error("Timetable API error:", err);
        return;
      }

      alert("Booking submitted and timetable updated!");
      window.location.href = "timetable.html?facility=" + encodeURIComponent(data.facility) + "&date=" + encodeURIComponent(data.bookingDate);

    } catch (error) {
      alert("Error submitting the form. Please try again later.");
      console.error("Submit error:", error);
    }
  }

  document.getElementById('bookingForm').addEventListener('submit', submitTimetable);
  </script>
</body>
</html>
