<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LHMS Admin Dashboard</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:#f0f0f0}

    .header{background:#4472C4;color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center}
    .header h1{font-size:24px}
    .header p{font-size:14px;margin-top:5px}
    .logout-btn{background:#e74c3c;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer}
    .logout-btn:hover{background:#c0392b}

    .nav-container{background:#fff;margin:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .nav-tabs{display:flex;border-bottom:1px solid #ddd}
    .tab{flex:1;padding:15px;text-align:center;background:#fff;border:none;cursor:pointer;font-size:14px;color:#666;position:relative}
    .tab.active{color:#4472C4;border-bottom:2px solid #4472C4}
    .tab:hover{background:#f8f9fa}
    /* Red dot on Inbox tab */
    .dot{display:none;position:absolute;top:10px;right:18px;width:10px;height:10px;border-radius:50%;background:#ef4444;box-shadow:0 0 0 2px #fff}

    .stats-container{display:flex;gap:20px;margin:20px}
    .stat-card{flex:1;background:#fff;padding:20px;border-radius:8px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .stat-card.blue{border-top:4px solid #3498db}
    .stat-card.green{border-top:4px solid #2ecc71}
    .stat-card.orange{border-top:4px solid #f39c12}
    .stat-number{font-size:36px;font-weight:bold;margin-bottom:10px}
    .stat-card.blue .stat-number{color:#3498db}
    .stat-card.green .stat-number{color:#2ecc71}
    .stat-card.orange .stat-number{color:#f39c12}
    .stat-label{color:#666;font-size:14px}

    .section{margin:20px;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .section-header{padding:20px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center}
    .section-title{font-size:18px;font-weight:bold;color:#333}
    .btn{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:14px}
    .btn-primary{background:#3498db;color:#fff}
    .btn-primary:hover{background:#2980b9}
    .btn-success{background:#2ecc71;color:#fff}
    .btn-success:hover{background:#27ae60}
    .btn-danger{background:#e74c3c;color:#fff}
    .btn-danger:hover{background:#c0392b}

    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 15px;text-align:left;border-bottom:1px solid #ddd}
    th{background:#f8f9fa;font-weight:bold;color:#555;font-size:12px;text-transform:uppercase}
    tr:hover{background:#f8f9fa}

    .status{padding:4px 8px;border-radius:12px;font-size:11px;font-weight:bold;text-transform:uppercase}
    .status-approved{background:#d4edda;color:#155724}
    .status-pending{background:#fff3cd;color:#856404}
    .action-buttons{display:flex;gap:5px}
    .action-btn{padding:4px 8px;border:none;border-radius:3px;cursor:pointer;font-size:11px;text-transform:uppercase}
    .btn-view,.btn-edit{background:#3498db;color:#fff}

    /* ===== Modals (Users/Inbox/Reply) ===== */
    .modal{display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5)}
    .modal-content{background:#fff;margin:5% auto;padding:0;border-radius:8px;width:90%;max-width:800px;box-shadow:0 4px 16px rgba(0,0,0,0.2)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;background:#f5f5f5;padding:12px 16px;border-bottom:1px solid #ddd}
    .modal-header h3{margin:0;font-size:18px}
    .modal-close{background:none;border:none;font-size:22px;cursor:pointer;color:#666}
    .modal-body{padding:16px}

    .filter-row{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
    .input,.select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
    .textarea{width:100%;min-height:120px;padding:10px;border:1px solid #e5e7eb;border-radius:8px;resize:vertical}

    .inbox-empty,.users-empty{color:#6b7280}

    .msg{border:1px solid #e5e7eb;border-radius:10px;padding:12px 14px;margin-bottom:10px;background:#fff}
    .msg.unread{border-color:#dbeafe;background:#f8fbff}
    .msg-head{display:flex;gap:8px;align-items:center;font-size:14px;color:#374151;margin-bottom:6px;flex-wrap:wrap}
    .msg-head b{color:#111827}
    .msg-meta{color:#6b7280;font-size:12px}
    .msg-body{color:#374151;margin:6px 0;white-space:pre-wrap}
    .msg-attach{font-size:12px;color:#2563eb;margin-top:6px}

    .users-table{width:100%;border-collapse:collapse}
    .users-table th,.users-table td{padding:10px 12px;border-bottom:1px solid #e5e7eb}
    .badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600}
    .badge-student{background:#eef2ff;color:#3730a3}
    .badge-staff{background:#ecfdf5;color:#065f46}

    @media (max-width:768px){
      .stats-container{flex-direction:column}
      .header{flex-direction:column;text-align:center;gap:10px}
      .nav-tabs{flex-direction:column}
      .section-header{flex-direction:column;gap:10px}
      .action-buttons{flex-direction:column}
      table{font-size:12px}
      th,td{padding:8px}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div>
      <h1>LHMS Admin Dashboard</h1>
      <p>Lecture Hall Management System</p>
    </div>
    <button class="logout-btn" onclick="window.location.href='index.html'">Logout</button>
  </div>

  <!-- Navigation -->
  <div class="nav-container">
    <div class="nav-tabs" id="tabs">
      <button class="tab active" data-users="1">Users</button>
      <button class="tab" data-link="facilitiesVIEW.html">Facilities</button>
      <button class="tab" data-link="timetable.html">Time Table</button>
      <button class="tab" data-link="bookinghistory.html">Booking History</button>
      <!-- SINGLE inbox tab with the red dot -->
      <button class="tab" data-inbox="1" id="inboxTab">
        Inbox <span id="inboxDot" class="dot"></span>
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-container">
    <div class="stat-card blue">
      <div class="stat-number" id="total-bookings">0</div>
      <div class="stat-label">Total Bookings</div>
    </div>
    <div class="stat-card green">
      <div class="stat-number" id="approved-bookings">0</div>
      <div class="stat-label">Approved Bookings</div>
    </div>
    <div class="stat-card orange">
      <div class="stat-number" id="pending-bookings">0</div>
      <div class="stat-label">Pending Approval</div>
    </div>
  </div>

  <!-- Approving Process -->
  <div class="section">
    <div class="section-header">
      <h2 class="section-title">Approving Process</h2>
      <button class="btn btn-primary" id="viewBookingsBtn">All Booking</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Facility</th>
          <th>Requested By</th>
          <th>Date & Time</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody class="recent-bookings-body"></tbody>
    </table>
  </div>

  <!-- Facility Sections -->
  <div class="section">
    <div class="section-header">
      <h2 class="section-title">Lecture Halls</h2>
      <button class="btn btn-success" onclick="window.location.href='facilitiesNEW.html?type=lecture_hall'">+ Add New Lecture Hall</button>
    </div>
    <table>
      <thead><tr><th>Hall ID</th><th>Name</th><th>Capacity</th><th>Facilities</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody class="lecturehall-body"></tbody>
    </table>
  </div>

  <div class="section">
    <div class="section-header">
      <h2 class="section-title">Computer Labs</h2>
      <button class="btn btn-success" onclick="window.location.href='facilitiesNEW.html?type=computer_lab'">+ Add New ComputerLab</button>
    </div>
    <table>
      <thead><tr><th>Hall ID</th><th>Name</th><th>Capacity</th><th>Facilities</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody class="computerlab-body"></tbody>
    </table>
  </div>

  <div class="section">
    <div class="section-header">
      <h2 class="section-title">Seminar Rooms</h2>
      <button class="btn btn-success" onclick="window.location.href='facilitiesNEW.html?type=seminar_room'">+ Add New Seminar Room</button>
    </div>
    <table>
      <thead><tr><th>Hall ID</th><th>Name</th><th>Capacity</th><th>Facilities</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody class="seminarroom-body"></tbody>
    </table>
  </div>

  <div class="section">
    <div class="section-header">
      <h2 class="section-title">Auditorium</h2>
      <button class="btn btn-success" onclick="window.location.href='facilitiesNEW.html?type=auditorium'">+ Add New Auditorium</button>
    </div>
    <table>
      <thead><tr><th>Hall ID</th><th>Name</th><th>Capacity</th><th>Facilities</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody class="auditorium-body"></tbody>
    </table>
  </div>

  <div class="section">
    <div class="section-header">
      <h2 class="section-title">Meeting Rooms</h2>
      <button class="btn btn-success" onclick="window.location.href='facilitiesNEW.html?type=meeting_room'">+ Add New Meeting Room</button>
    </div>
    <table>
      <thead><tr><th>Hall ID</th><th>Name</th><th>Capacity</th><th>Facilities</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody class="meetingroom-body"></tbody>
    </table>
  </div>

  <!-- USERS MODAL -->
  <div id="usersModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Registered Users</h3>
        <button class="modal-close" id="usersClose" title="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="filter-row">
          <input id="usersSearch" class="input" type="text" placeholder="Search by name or email…"/>
          <select id="usersType" class="select">
            <option value="">All types</option>
            <option value="Academic Staff">Academic Staff</option>
            <option value="Student">Student</option>
          </select>
        </div>
        <div id="usersWrap">
          <p class="users-empty">Click the Users tab to load users.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- INBOX MODAL -->
  <div id="inboxModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Inbox</h3>
        <button class="modal-close" id="inboxClose" title="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="filter-row">
          <input id="inboxSearch" class="input" type="text" placeholder="Search by sender, subject, or message..."/>
          <select id="inboxPriority" class="select">
            <option value="">All priorities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
          <button class="btn btn-primary" id="markAllReadBtn" title="Mark all visible as read">Mark Visible Read</button>
        </div>
        <div id="inboxList"><p class="inbox-empty">Loading messages…</p></div>
      </div>
    </div>
  </div>

  <!-- REPLY MODAL -->
  <div id="replyModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:600px">
      <div class="modal-header">
        <h3>Reply to Complaint</h3>
        <button class="modal-close" id="replyClose" title="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="filter-row" style="gap:12px">
          <input id="replyTo" class="input" type="text" placeholder="To" readonly/>
          <input id="replySubj" class="input" type="text" placeholder="Subject"/>
        </div>
        <textarea id="replyBody" class="textarea" placeholder="Write your message..."></textarea>
        <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
          <button class="btn btn-secondary" id="replyCancelBtn">Cancel</button>
          <button class="btn btn-primary" id="replySendBtn">Send</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const API_BASE = (location.protocol === 'file:') ? 'http://localhost:3000' : '';

  // Tabs: Users + Inbox open modals; others navigate
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', function(){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      this.classList.add('active');

      if (this.dataset.users === '1') openUsers();
      else if (this.dataset.inbox === '1') openInbox();
      else if (this.dataset.link) window.location.href = this.dataset.link;
    });
  });

  // View all bookings btn
  document.getElementById('viewBookingsBtn').onclick = ()=> window.location.href='bookingSTATUS.html';

  // Stats
  async function fetchStats(){
    try{
      const [a,b,c] = await Promise.all([
        fetch(`${API_BASE}/api/bookings-total`),
        fetch(`${API_BASE}/api/approved-bookings-total`),
        fetch(`${API_BASE}/api/pending-bookings-total`)
      ]);
      const A = await a.json(), B = await b.json(), C = await c.json();
      document.getElementById('total-bookings').textContent = A.total ?? 0;
      document.getElementById('approved-bookings').textContent = B.total ?? 0;
      document.getElementById('pending-bookings').textContent = C.total ?? 0;
    }catch(e){
      document.getElementById('total-bookings').textContent='!';
      document.getElementById('approved-bookings').textContent='!';
      document.getElementById('pending-bookings').textContent='!';
    }
  }
  fetchStats();

  // Facilities
  async function loadFacilitiesByType(type, sel){
    try{
      const res = await fetch(`${API_BASE}/api/facilities/${type}`);
      const list = await res.json();
      const tbody = document.querySelector(sel);
      tbody.innerHTML='';
      list.forEach(f=>{
        let facs = Array.isArray(f.facilities) ? f.facilities
                 : (typeof f.facilities==='string'?f.facilities.split(',').map(x=>x.trim()).filter(Boolean):[]);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHtml(f.facilityCode||'N/A')}</td>
          <td>${escapeHtml(f.facilityName||'')}</td>
          <td>${f.capacity ?? ''}</td>
          <td>${facs.map(escapeHtml).join(', ')}</td>
          <td><span class="status ${f.status==='available'?'status-approved':'status-pending'}">${escapeHtml(f.status||'')}</span></td>
          <td>
            <div class="action-buttons">
              <button class="action-btn btn-view" data-id="${f._id}" data-type="${type}">View</button>
              <button class="action-btn btn-edit" data-id="${f._id}" data-type="${type}">Edit</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }catch(e){ console.error(`Error loading ${type}:`, e); }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    loadFacilitiesByType('lecture_hall', '.lecturehall-body');
    loadFacilitiesByType('computer_lab', '.computerlab-body');
    loadFacilitiesByType('seminar_room', '.seminarroom-body');
    loadFacilitiesByType('auditorium', '.auditorium-body');
    loadFacilitiesByType('meeting_room', '.meetingroom-body');
    loadBookings();
  });

  // View/Edit handlers
  document.addEventListener('click', (e)=>{
    if (e.target.classList.contains('btn-edit')){
      const id=e.target.dataset.id, type=e.target.dataset.type;
      window.location.href=`facilitiesNEW.html?type=${encodeURIComponent(type)}&id=${encodeURIComponent(id)}`;
    }
    if (e.target.classList.contains('btn-view')){
      const id=e.target.dataset.id, type=e.target.dataset.type;
      window.location.href=`facilitiesVIEW.html?type=${encodeURIComponent(type)}&id=${encodeURIComponent(id)}`;
    }
  });

  // Approved bookings list
  async function loadBookings(){
    try{
      const res=await fetch(`${API_BASE}/api/approved-bookings`);
      const bookings=await res.json();
      const tbody=document.querySelector('.recent-bookings-body');
      tbody.innerHTML='';
      bookings.forEach((b,i)=>{
        const when = b.bookingDate ? new Date(b.bookingDate) : null;
        const tr=document.createElement('tr');
        tr.dataset.id=b._id;
        tr.innerHTML=`
          <td>#LH-${i+1}</td>
          <td>${escapeHtml(b.facility||'')}</td>
          <td>${escapeHtml(b.fullname||'')} (${escapeHtml(b.email||'')})</td>
          <td>${when?when.toLocaleDateString():''} • ${escapeHtml(b.startTime||'')} - ${escapeHtml(b.endTime||'')}</td>
          <td><span class="status status-approved">Approved</span></td>`;
        tbody.appendChild(tr);
      });
    }catch(e){ console.error('Error loading approved bookings:', e); }
  }

  /* ================= Helpers ================= */
  function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
  function formatWhen(d){ try{return new Date(d).toLocaleString();}catch{return '';} }

  /* ================= USERS POPUP ================= */
  const usersModal = document.getElementById('usersModal');
  const usersClose = document.getElementById('usersClose');
  const usersWrap  = document.getElementById('usersWrap');
  const usersSearch = document.getElementById('usersSearch');
  const usersType = document.getElementById('usersType');
  let allUsers = [];

  function openUsers(){
    usersModal.style.display='block';
    usersModal.setAttribute('aria-hidden','false');
    loadUsers();
  }
  function closeUsers(){
    usersModal.style.display='none';
    usersModal.setAttribute('aria-hidden','true');
  }
  usersClose.onclick = closeUsers;
  window.addEventListener('click', (e)=>{ if(e.target===usersModal) closeUsers(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeUsers(); });

  async function loadUsers(){
    usersWrap.innerHTML = `<p class="users-empty">Loading users…</p>`;
    try{
      const res = await fetch(`${API_BASE}/api/users`, {cache:'no-store'});
      allUsers = await res.json();
    }catch{ allUsers = []; }
    renderUsers();
  }

  function typeParamFromLabel(label){ return (label === 'Academic Staff') ? 'staff' : 'student'; }

  async function deleteUser(id, userTypeLabel){
    const typeParam = typeParamFromLabel(userTypeLabel);
    if (!id || !typeParam) return alert('Missing user info.');
    if (!confirm('Delete this user account? This action cannot be undone.')) return;
    try{
      const res = await fetch(`${API_BASE}/api/users/${encodeURIComponent(id)}?type=${encodeURIComponent(typeParam)}`, {
        method: 'DELETE'
      });
      if (!res.ok){
        const j = await res.json().catch(()=>({}));
        throw new Error(j.message || 'Delete failed');
      }
      await loadUsers();
      alert('User deleted.');
    }catch(e){ alert('Error: ' + e.message); }
  }

  function renderUsers(){
    const needle = (usersSearch.value||'').toLowerCase().trim();
    const typ = usersType.value;
    const filtered = allUsers.filter(u=>{
      const tOk = !typ || u.userType === typ;
      const text = `${u.fullname||''} ${u.email||''}`.toLowerCase();
      return tOk && (!needle || text.includes(needle));
    });

    if (!filtered.length){
      usersWrap.innerHTML = `<p class="users-empty">No users found.</p>`;
      return;
    }

    const rows = filtered.map(u=>`
      <tr>
        <td>${escapeHtml(u.fullname||'')}</td>
        <td>${escapeHtml(u.email||'')}</td>
        <td>${u.userType==='Academic Staff'
              ? '<span class="badge badge-staff">Academic Staff</span>'
              : '<span class="badge badge-student">Student</span>'}
        </td>
        <td style="width:1%;white-space:nowrap;">
          <button class="btn btn-danger" data-del="1" data-id="${escapeHtml(u.id||'')}" data-type="${escapeHtml(u.userType||'')}">Delete</button>
        </td>
      </tr>`).join('');

    usersWrap.innerHTML = `
      <table class="users-table">
        <thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Actions</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;

    usersWrap.querySelectorAll('[data-del="1"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ deleteUser(btn.dataset.id, btn.dataset.type); });
    });
  }

  usersSearch.addEventListener('input', renderUsers);
  usersType.addEventListener('change', renderUsers);

  /* ================= INBOX + RED DOT ================= */
  const inboxModal = document.getElementById('inboxModal');
  const inboxClose = document.getElementById('inboxClose');
  const inboxList  = document.getElementById('inboxList');
  const inboxSearch = document.getElementById('inboxSearch');
  const inboxPriority = document.getElementById('inboxPriority');
  const markAllReadBtn = document.getElementById('markAllReadBtn');
  const inboxDot = document.getElementById('inboxDot');
  let inboxItems = [];

  function openInbox(){
    inboxModal.style.display='block';
    inboxModal.setAttribute('aria-hidden','false');
    loadInbox();
  }
  function closeInbox(){
    inboxModal.style.display='none';
    inboxModal.setAttribute('aria-hidden','true');
  }
  document.getElementById('inboxTab').addEventListener('click', openInbox);
  inboxClose.onclick = closeInbox;
  window.addEventListener('click', (e)=>{ if(e.target===inboxModal) closeInbox(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeInbox(); });

  async function loadInbox(){
    inboxList.innerHTML = `<p class="inbox-empty">Loading messages…</p>`;
    try{
      const res = await fetch(`${API_BASE}/api/inbox`, {
        cache:'no-store',
        headers: { 'x-admin-key': localStorage.getItem('admin_key') || '' }
      });
      if(!res.ok) throw 0;
      inboxItems = await res.json();
    }catch{ inboxItems = []; }
    renderInbox();
  }

  function renderInbox(){
    const q = (inboxSearch.value||'').toLowerCase().trim();
    const pr = inboxPriority.value;
    const filtered = inboxItems.filter(m=>{
      const text = `${m.fullname||''} ${m.email||''} ${m.subject||''} ${m.message||''}`.toLowerCase();
      const qp = !pr || (m.priority||'').toLowerCase()===pr;
      return (!q || text.includes(q)) && qp;
    });

    if (!filtered.length){ inboxList.innerHTML = `<p class="inbox-empty">No messages.</p>`; return; }

    inboxList.innerHTML = filtered.map(m=>`
      <div class="msg ${m.isRead ? '' : 'unread'}" data-id="${escapeHtml(m._id||'')}">
        <div class="msg-head">
          <b>${escapeHtml(m.fullname||'Unknown')}</b>
          <span class="msg-meta">• ${escapeHtml(m.email||'')}</span>
          <span class="msg-meta">• ${(m.priority||'').toUpperCase()}</span>
          <span class="msg-meta">• ${formatWhen(m.createdAt)}</span>
          ${m.isRead ? '' : '<span class="msg-meta" style="color:#ef4444;font-weight:700;">• UNREAD</span>'}
        </div>
        <div class="msg-body"><b>${escapeHtml(m.subject||'')}</b><br>${escapeHtml(m.message||'')}</div>
        ${m.attachmentUrl?`<div class="msg-attach">Attachment: <a href="${m.attachmentUrl}" target="_blank" rel="noopener">view</a></div>`:''}
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn btn-primary btn-reply" data-id="${escapeHtml(m._id||'')}" data-email="${escapeHtml(m.email||'')}" data-subj="${escapeHtml(m.subject||'')}">Reply</button>
          <button class="btn btn-danger btn-delete" data-id="${escapeHtml(m._id||'')}">Delete</button>
        </div>
      </div>`).join('');
		markAllReadBtn.addEventListener('click', async () => {
		  const visibleIds = Array.from(
			inboxList.querySelectorAll('.msg')
		  ).map(div => div.getAttribute('data-id'));

		  for (const id of visibleIds) {
			const item = inboxItems.find(x => String(x._id) === String(id));
			if (item && !item.isRead) {
			  const ok = await markComplaintRead(id);
			  if (ok) {
				item.isRead = true;
				item.readAt = new Date().toISOString();
			  }
			}
		  }
		  renderInbox();
		  refreshInboxDot();
		});


		// click to mark read (ignore button clicks)
		inboxList.querySelectorAll('.msg').forEach(div => {
		  div.addEventListener('click', async (ev) => {
			if (ev.target.closest('button')) return;  // ignore Reply/Delete buttons
			const id = div.getAttribute('data-id');
			if (!id) return;

			const item = inboxItems.find(x => String(x._id) === String(id));
			if (!item || item.isRead) return;

			const ok = await markComplaintRead(id);
			if (ok) {
			  item.isRead = true;
			  item.readAt = new Date().toISOString();
			  renderInbox();
			  refreshInboxDot();
			}
		  });
		});


    // reply
    inboxList.querySelectorAll('.btn-reply').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        openReply({ id: btn.dataset.id, email: btn.dataset.email || '', subject: btn.dataset.subj || '' });
      });
    });

    // delete
    inboxList.querySelectorAll('.btn-delete').forEach(btn=>{
      btn.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        const id = btn.dataset.id;
        if (!id) return;
        if (!confirm('Delete this complaint? This action cannot be undone.')) return;
        try{
          const res = await fetch(`${API_BASE}/api/complains/${encodeURIComponent(id)}`, {
            method: 'DELETE',
            headers: { 'x-admin-key': localStorage.getItem('admin_key') || '' }
          });
          if (!res.ok) throw 0;
          inboxItems = inboxItems.filter(x => String(x._id) !== String(id));
          renderInbox();
          refreshInboxDot();
        }catch{ alert('Delete failed.'); }
      });
    });
  }

  inboxSearch.addEventListener('input', renderInbox);
  inboxPriority.addEventListener('change', renderInbox);

  async function markComplaintRead(id){
    try{
      const res = await fetch(`${API_BASE}/api/complains/${encodeURIComponent(id)}/read`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'x-admin-key': localStorage.getItem('admin_key') || ''
        }
      });
      return res.ok;
    }catch(e){ return false; }
  }

  // Unread red dot
  async function refreshInboxDot(){
    try{
      const res = await fetch(`${API_BASE}/api/inbox/unread-count`, {
        cache: 'no-store',
        headers: { 'x-admin-key': localStorage.getItem('admin_key') || '' }
      });
      if (!res.ok) throw 0;
      const { count } = await res.json();
      inboxDot.style.display = (count > 0) ? 'block' : 'none';
    } catch{ inboxDot.style.display = 'none'; }
  }
  setInterval(refreshInboxDot, 15000);
  refreshInboxDot();

  // SSE: live notify red dot
  function setupComplainSSE(){
    try{
      const es = new EventSource(`${API_BASE}/api/stream/complains`);
      es.onmessage = () => { refreshInboxDot(); };
      es.onerror = () => {};
    }catch(e){}
  }
  setupComplainSSE();

  /* ===== Reply modal logic ===== */
  const replyModal = document.getElementById('replyModal');
  const replyClose = document.getElementById('replyClose');
  const replyTo = document.getElementById('replyTo');
  const replySubj = document.getElementById('replySubj');
  const replyBody = document.getElementById('replyBody');
  const replySendBtn = document.getElementById('replySendBtn');
  const replyCancelBtn = document.getElementById('replyCancelBtn');
  let replyCtx = { id:null, email:'', subject:'' };

  function openReply({id,email,subject}){
    replyCtx = { id, email, subject };
    replyTo.value = email || '';
    replySubj.value = subject ? `Re: ${subject}` : 'Re: ';
    replyBody.value = '';
    replyModal.style.display='block';
    replyModal.setAttribute('aria-hidden','false');
  }
  function closeReply(){
    replyModal.style.display='none';
    replyModal.setAttribute('aria-hidden','true');
  }
  replyClose.onclick = closeReply;
  replyCancelBtn.onclick = closeReply;
  window.addEventListener('click', (e)=>{ if(e.target===replyModal) closeReply(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeReply(); });

  replySendBtn.addEventListener('click', async ()=>{
    if (!replyCtx.id) return closeReply();
    const payload = { subject: replySubj.value || 'Re:', message: replyBody.value || '' };
    try{
      const res = await fetch(`${API_BASE}/api/complains/${encodeURIComponent(replyCtx.id)}/reply`, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'x-admin-key': localStorage.getItem('admin_key') || ''
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw 0;
      alert('Reply sent.');
      closeReply();
    }catch{ alert('Failed to send reply.'); }
  });
</script>
</body>
</html>
